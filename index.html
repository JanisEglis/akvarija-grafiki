<!doctype html>
<html lang="lv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Akvārija panelis</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<style>
  :root{
    --bg:#0f172a; --card:#111827; --card2:#0b1220;
    --text:#e5e7eb; --muted:#9ca3af;
    --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
    --border:#1f2937;
  }
  html,body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1200px;margin:16px auto;padding:0 14px}
  header{display:flex;align-items:center;gap:12px;margin-bottom:8px}
  header h1{margin:0;font-size:28px;font-weight:800;letter-spacing:.5px}
  .bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px 12px}
  .pill{display:inline-block;padding:.3em .7em;border-radius:999px;font-size:12px}
  .ok{background:#064e3b;color:#a7f3d0}
  .warn{background:#7c2d12;color:#fed7aa}
  .err{background:#7f1d1d;color:#fecaca}
  .ctrls{display:flex;gap:8px;align-items:center;margin-left:auto}
  select,button,input[type="number"]{background:#1f2937;border:1px solid #303646;color:var(--text);border-radius:8px;padding:8px 10px;cursor:pointer}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:12px}
  @media (max-width:920px){ .grid{grid-template-columns:1fr} }
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px}
  .card .head{padding:10px 12px;border-bottom:1px solid var(--border);font-weight:600}
  .pane{height:420px}
  .error{background:#7f1d1d;color:#fecaca;padding:10px 12px;border-radius:10px;margin:10px 0;display:none}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  /* Dropdown (details) */
  details.dropdown{background:var(--card);border:1px solid var(--border);border-radius:12px;margin-top:14px}
  details.dropdown>summary{cursor:pointer;list-style:none;padding:10px 12px;font-weight:600;user-select:none}
  details.dropdown>summary::-webkit-details-marker{display:none}
  .drop-body{padding:0 12px 12px 12px}
  .events{max-height:320px;overflow:auto;border-top:1px solid var(--border)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 10px;border-bottom:1px solid var(--border);font-size:13px}
  th{color:var(--muted);text-align:left;position:sticky;top:0;background:var(--card2)}
  header img.logo{
  height:40px;          /* vai 36px, ja gribi mazāku */
  width:auto;
  display:block;
  border-radius:8px;    /* ja gribi noapaļotus stūrus */
}

</style>
</head>
<body>
<div class="wrap">
  <header>
  
  <img
    class="logo"
    src="https://raw.githubusercontent.com/JanisEglis/akvarija-grafiki/main/fish%20web.png"
    alt="Akvārija logo"
  />

    <h1>Akvārija panelis</h1>
  </header>

  <div id="err" class="error"></div>

  <!-- Statuse + kontrole vienā joslā -->
  <div class="bar" id="statusBar">
    <span class="pill ok"   id="stat-water">Ūdens: —</span>
    <span class="pill warn" id="stat-alarm">Signalizācija: —</span>
    <span class="pill ok"   id="stat-wifi">Wi-Fi: —</span>
    <span class="pill warn" id="stat-clean">Tīrīt pēc: —</span>
    <span class="pill ok"   id="stat-feed">Barošana: —</span>

    <div class="ctrls">
      <label>Laika periods:</label>
      <select id="range">
        <option value="24h">Pēdējās 24 h</option>
        <option value="7d">Pēdējās 7 dienas</option>
        <option value="30d">Pēdējās 30 dienas</option>
        <option value="all">Viss periods</option>
      </select>
      <button id="refresh">Atjaunot</button>
      <label class="mono">Auto (min):</label>
      <input id="autoMins" type="number" min="0" step="1" value="0" style="width:80px">
      <button id="applyAuto">Iestatīt</button>
    </div>
  </div>

  <!-- Grafiki blakus -->
  <div class="grid">
    <div class="card">
      <div class="head">Temperatūra (°C)</div>
      <div id="temp" class="pane"></div>
    </div>
    <div class="card">
      <div class="head">LED, Dzesēšana, Ūdens</div>
      <div id="lf" class="pane"></div>
    </div>
  </div>

  <!-- Notikumi kā dropdown -->
  <details class="dropdown" id="eventsDrop">
    <summary>Notikumu žurnāls</summary>
    <div class="drop-body">
      <div class="events">
        <table id="events">
          <thead><tr><th>Laiks</th><th>Notikums</th><th>Detalizācija</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </details>
</div>

<!-- Bibliotēkas -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
/*** DATU AVOTS ***/
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQZnVtmAM6S2H1BTJhqKqIPFPh5aU9AWYJclFDU2f4J-k3ouRNMFyjYEZo8xIfxwHT-SjMBAUWOl1PX/pub?gid=0&single=true&output=csv';
const CORS_PROXY = ''; // vajadzības gadījumā: 'https://cors.isomorphic-git.org/'

/*** Kolonnu aliasi ***/
const KEY = {
  time:  ['Laiks'],
  temp:  ['Temp'],
  led:   ['LED'],
  fan:   ['Dzesēšana','Dzesesana'],
  alarm: ['Signalizācija','Signalizacija'],
  water: ['Ūdens līmenis','Ūdens limenis','Udens līmenis','Udens limenis'],
  clean: ['Tīrīt pēc (s)','Tīrīt pēc','Tirit pec (s)','Tirit pec'],
  feed:  ['Barošana','Barosana'],
  wifi:  ['WiFi OK','Wi-Fi OK','Wifi OK','WiFi','WIFI OK'],
  fanMode:['Fan rež.','Fan rez.','Fan režīms','Fan režims','Fan rezims']
};

/*** UI elementi ***/
const elErr = document.getElementById('err');
const selRange = document.getElementById('range');
const btnRefresh = document.getElementById('refresh');
const inputAuto = document.getElementById('autoMins');
const btnApplyAuto = document.getElementById('applyAuto');
const tbody = document.querySelector('#events tbody');

let chTemp = echarts.init(document.getElementById('temp'), null, {renderer:'canvas'});
let chLF   = echarts.init(document.getElementById('lf'),   null, {renderer:'canvas'});
window.addEventListener('resize', ()=>{ chTemp.resize(); chLF.resize(); });
let autoTimer = null;

/*** Palīgfunkcijas ***/
function showError(msg){ elErr.style.display='block'; elErr.textContent=msg; console.error(msg); }
function hideError(){ elErr.style.display='none'; }

const parseLVDate = s => {
  if (!s) return NaN;
  const [date, time='00:00:00'] = String(s).trim().split(' ');
  const [Y,M,D] = date.split('.').map(n=>parseInt(n,10));
  const [h,m,ss] = time.split(':').map(n=>parseInt(n,10));
  return new Date(Y, (M||1)-1, D||1, h||0, m||0, ss||0).getTime();
};
const toNum = x => Number(String(x??'').replace(/[ \u00A0]/g,'').replace(',', '.')) || 0;
const fmtSec = s => { s=Number(s)||0; const d=Math.floor(s/86400); s%=86400; const h=Math.floor(s/3600); s%=3600; const m=Math.floor(s/60);
  return (d?d+'d ':'')+String(h).padStart(2,'0')+':'+String(m).padStart(2,'0');
};
const norm = s => String(s||'').trim().toUpperCase();

/* virsrakstu normalizācija */
const canon = s => String(s||'').normalize('NFKD').replace(/[\u0300-\u036f]/g,'').replace(/[.\u00A0]/g,' ').replace(/\s+/g,' ').trim().toUpperCase();
const rowKeyCache = new WeakMap();
function rowMap(row){ let m=rowKeyCache.get(row); if(m) return m; m={}; for(const k of Object.keys(row)) m[canon(k)]=row[k]; rowKeyCache.set(row,m); return m;}
function pick(row, aliases){ const m=rowMap(row); for(const a of aliases){ const v=m[canon(a)]; if(v!==undefined && String(v).trim()!=='') return v; } return ''; }
function lastNonEmpty(rows, aliases){ for(let i=rows.length-1;i>=0;i--){ const v=pick(rows[i],aliases); if(String(v).trim()!=='') return v; } return ''; }
function feedNums(s){ const m=String(s||'').match(/(\d+)\s*\/\s*(\d+)/); return m?{n:+m[1],total:+m[2]}:{n:null,total:null}; }

async function loadCSVObjects(){
  const url = (CORS_PROXY ? CORS_PROXY + CSV_URL : CSV_URL) + '&_=' + Date.now();
  const res = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error('HTTP '+res.status+' – nevar ielādēt CSV');
  const txt = await res.text();
  const parsed = Papa.parse(txt, { header:true, skipEmptyLines:true });
  if (parsed.errors?.length) console.warn(parsed.errors);
  return parsed.data;
}
function filterByRange(objs, range){
  if (range==='all') return objs;
  const now=Date.now(), span=range==='24h'?864e5:range==='7d'?7*864e5:30*864e5;
  return objs.filter(o=>{ const t=parseLVDate(pick(o,KEY.time)); return isFinite(t)&&(now-t)<=span; });
}

function setPill(id, text, cls){ const el=document.getElementById(id); el.textContent=text; el.className='pill '+cls; }

function render(objs){
  if(!objs.length) throw new Error('Nav datu izvēlētajam periodam.');

  const T=[], TEMP=[], LED=[], FAN=[], WATERP=[];
  for(const o of objs){
    const ts=parseLVDate(pick(o,KEY.time)); if(!isFinite(ts)) continue;
    T.push(ts);
    TEMP.push(toNum(pick(o,KEY.temp)));
    LED.push(toNum(pick(o,KEY.led)));
    FAN.push(toNum(pick(o,KEY.fan)));
    const wl=pick(o,KEY.water); WATERP.push(norm(wl)==='OK'?100:0);
  }
  if(!T.length) throw new Error('Nav derīgu rindu.');

  // statusa tabletes
  const wifi = lastNonEmpty(objs, KEY.wifi);
  const wlvl = lastNonEmpty(objs, KEY.water);
  const alarm= lastNonEmpty(objs, KEY.alarm);
  const cleanSVal = toNum(lastNonEmpty(objs, KEY.clean));
  setPill('stat-water', 'Ūdens: '+(wlvl||'—'), (norm(wlvl)==='OK')?'ok':'err');
  setPill('stat-alarm', 'Signalizācija: '+(alarm||'—'), (norm(alarm)==='IESLĒGTA')?'warn':'ok');
  setPill('stat-wifi',  'Wi-Fi: '+(wifi||'—'), (norm(wifi)==='OK')?'ok':'err');
  setPill('stat-clean', 'Tīrīt pēc: '+(cleanSVal>0 ? fmtSec(cleanSVal) : (cleanSVal===0?'jātīra':'—')), (cleanSVal>0)?'warn':'err');
  setPill('stat-feed',  'Barošana: '+(lastNonEmpty(objs, KEY.feed)||'—'), 'ok');

  // notikumi (ģenerējam, bet rādām tikai dropdownā)
  tbody.innerHTML='';
  const ev=[];
  for(let i=0;i<objs.length;i++){
    const o=objs[i], p=objs[i-1]; const t=new Date(parseLVDate(pick(o,KEY.time))).toLocaleString('lv-LV');
    const a=norm(pick(o,KEY.alarm)), ap=p?norm(pick(p,KEY.alarm)):'';
    if(!p||a!==ap){ if(a==='IESLĒGTA') ev.push([t,'Signalizācija','IESLĒGTA']); if(p&&ap==='IESLĒGTA'&&a!=='IESLĒGTA') ev.push([t,'Signalizācija','Izslēgta']); }
    const w=norm(pick(o,KEY.water)), wp=p?norm(pick(p,KEY.water)):'';
    if(!p||w!==wp){ if(w==='ZEMS') ev.push([t,'Ūdens līmenis','Zems']); if(p&&wp==='ZEMS'&&w==='OK') ev.push([t,'Ūdens līmenis','Atjaunojies OK']); }
    const wi=norm(pick(o,KEY.wifi)), wip=p?norm(pick(p,KEY.wifi)):'';
    if(!p||wi!==wip){ if(wi==='OK') ev.push([t,'Wi-Fi','Savienots']); if(wi==='ERR'||wi==='NO') ev.push([t,'Wi-Fi','Zudis savienojums']); }
    const sNow=toNum(pick(o,KEY.clean)), sPrev=p?toNum(pick(p,KEY.clean)):null;
    if(sPrev!==null&&sPrev>0&&sNow<=0) ev.push([t,'Tīrīšana','Termiņš beidzies (jātīra)']);
    if(sPrev!==null&&sNow-sPrev>86400) ev.push([t,'Tīrīšana','Taimeris atiestatīts']);
    const f=pick(o,KEY.feed), fp=p?pick(p,KEY.feed):''; const fn=feedNums(f), fpn=feedNums(fp);
    if(p&&fn.n!==null&&(fn.n!==fpn.n||fn.total!==fpn.total)) ev.push([t,'Barošana',`${fn.n}/${fn.total}`]);
    const fanNow=toNum(pick(o,KEY.fan)), fanPrev=p?toNum(pick(p,KEY.fan)):null;
    const modeNow=norm(pick(o,KEY.fanMode)), modePrev=p?norm(pick(p,KEY.fanMode)):'';
    if(fanPrev!==null){ if(fanPrev===0&&fanNow>0) ev.push([t,'Dzesēšana','Sākta ('+(modeNow||'AUTO')+'), '+fanNow+'%']); if(fanPrev>0&&fanNow===0) ev.push([t,'Dzesēšana','Apturēta']); }
    if(p&&modeNow&&modeNow!==modePrev) ev.push([t,'Dzesēšanas režīms',modeNow]);
    const ledNow=toNum(pick(o,KEY.led)), ledPrev=p?toNum(pick(p,KEY.led)):null;
    if(ledPrev!==null && Math.abs(ledNow-ledPrev)>=10) ev.push([t,'LED',ledNow+'%']);
  }
  ev.reverse().slice(0,300).forEach(([t,what,det])=>{
    const tr=document.createElement('tr'); tr.innerHTML=`<td class="mono">${t}</td><td>${what}</td><td>${det}</td>`; tbody.appendChild(tr);
  });

  // Temperatūras robežas
  const tMin=Math.min(...TEMP), tMax=Math.max(...TEMP);
  const pad=.4, yMin=Math.floor((tMin-pad)*10)/10, yMax=Math.ceil((tMax+pad)*10)/10;

  // Temperatūra
  chTemp.setOption({
    tooltip:{trigger:'axis'},
    grid:{left:46,right:14,top:18,bottom:36},
    xAxis:{type:'time'},
    yAxis:{type:'value',name:'°C',min:yMin,max:yMax},
    series:[{type:'line',name:'Temperatūra',data:T.map((t,i)=>[t,TEMP[i]]),smooth:true,showSymbol:false,symbol:'none',emphasis:{disabled:true},lineStyle:{width:2}}]
  });

  // LED / Dzesēšana / Ūdens
  chLF.setOption({
    tooltip:{trigger:'axis'},
    grid:{left:46,right:14,top:30,bottom:36},
    legend:{top:4,icon:'rect',itemWidth:14,itemHeight:6,textStyle:{color:'#e5e7eb'},inactiveColor:'#6b7280',
            data:[{name:'LED %'},{name:'Dzesēšana %'},{name:'Ūdens (0/100)'}]},
    xAxis:{type:'time'},
    yAxis:{type:'value',name:'%',min:0,max:100},
    series:[
      {type:'line',name:'LED %',data:T.map((t,i)=>[t,LED[i]]),smooth:true,showSymbol:false,symbol:'none',emphasis:{disabled:true},lineStyle:{width:2}},
      {type:'line',name:'Dzesēšana %',data:T.map((t,i)=>[t,FAN[i]]),smooth:true,showSymbol:false,symbol:'none',emphasis:{disabled:true},lineStyle:{width:2}},
      {type:'line',name:'Ūdens (0/100)',data:T.map((t,i)=>[t,WATERP[i]]),step:true,showSymbol:false,symbol:'none',emphasis:{disabled:true},lineStyle:{width:2}}
    ]
  });
}

async function loadAndRender(){
  try{ hideError(); const all=await loadCSVObjects(); const filtered=filterByRange(all, selRange.value); render(filtered); }
  catch(e){ showError('Datu ielādes/parsēšanas kļūda: '+e.message); }
}

/*** Notikumi ***/
btnRefresh.addEventListener('click', loadAndRender);
btnApplyAuto.addEventListener('click', ()=>{
  const mins=Math.max(0, parseInt(inputAuto.value||'0',10));
  if(autoTimer){ clearInterval(autoTimer); autoTimer=null; }
  if(mins>0) autoTimer=setInterval(loadAndRender, mins*60*1000);
  loadAndRender();
});

/*** Start ***/
document.addEventListener('DOMContentLoaded', loadAndRender);
</script>
</body>
</html>
